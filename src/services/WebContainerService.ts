import { WebContainer } from '@webcontainer/api';
import type { FileSystemTree } from '@webcontainer/api';

class WebContainerService {
  private static instance: WebContainerService;
  private webContainerInstance: WebContainer | null = null;
  private bootPromise: Promise<void> | null = null;

  private constructor() {
    // Private constructor to enforce singleton
  }

  public static getInstance(): WebContainerService {
    if (!WebContainerService.instance) {
      WebContainerService.instance = new WebContainerService();
    }
    return WebContainerService.instance;
  }

  public async boot(): Promise<void> {
    if (this.webContainerInstance) {
      console.log('WebContainer already booted');
      return;
    }

    if (this.bootPromise) {
        return this.bootPromise;
    }

    this.bootPromise = (async () => {
        try {
          this.webContainerInstance = await WebContainer.boot();
          console.log('WebContainer Booted');
        } catch (error) {
          console.error('Failed to boot WebContainer:', error);
          this.bootPromise = null; // Reset promise on failure
          throw error;
        }
    })();

    return this.bootPromise;
  }

  public getContainer(): WebContainer | null {
    return this.webContainerInstance;
  }

  public async mount(fileTree: FileSystemTree) {
    if (!this.webContainerInstance) throw new Error('WebContainer not booted');
    await this.webContainerInstance.mount(fileTree);
  }

  public async installDependencies(callback?: (data: string) => void) {
    if (!this.webContainerInstance) throw new Error('WebContainer not booted');
    const installProcess = await this.webContainerInstance.spawn('npm', ['install']);

    installProcess.output.pipeTo(new WritableStream({
      write(data) {
        console.log('[npm install]', data);
        callback?.(data);
      }
    }));

    return installProcess.exit;
  }

  public async startDevServer(callback?: (data: string) => void) {
    if (!this.webContainerInstance) throw new Error('WebContainer not booted');
    const devProcess = await this.webContainerInstance.spawn('npm', ['run', 'dev']);

    devProcess.output.pipeTo(new WritableStream({
      write(data) {
        console.log('[dev server]', data);
        callback?.(data);
      }
    }));

    return devProcess;
  }

  public onServerReady(callback: (port: number, url: string) => void) {
     if (!this.webContainerInstance) throw new Error('WebContainer not booted');
     this.webContainerInstance.on('server-ready', callback);
  }
}

export const webContainerService = WebContainerService.getInstance();
